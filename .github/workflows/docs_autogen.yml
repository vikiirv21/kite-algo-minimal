name: Auto-Generate Documentation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Check for relevant file changes
      id: check_changes
      run: |
        echo "Checking for relevant file changes..."
        
        # Define files to watch
        WATCH_FILES=(
          "engine/paper_engine.py"
          "engine/live_engine.py"
          "broker/execution_router.py"
          "core/strategy_engine_v2.py"
          "core/risk_engine.py"
          "core/risk_engine_v2.py"
          "core/market_data_engine.py"
          "core/indicators.py"
          "strategies/"
          "ui/dashboard.py"
        )
        
        # Check if any watched files changed
        CHANGED=false
        for file in "${WATCH_FILES[@]}"; do
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "$file"; then
            echo "âœ“ Detected change in: $file"
            CHANGED=true
          fi
        done
        
        echo "has_changes=$CHANGED" >> $GITHUB_OUTPUT
    
    - name: Generate documentation
      run: |
        echo "Generating documentation..."
        python scripts/generate_docs.py
        
        # Check if docs were modified
        if git diff --quiet docs/; then
          echo "âœ“ Documentation is up to date"
          echo "DOCS_CHANGED=false" >> $GITHUB_ENV
        else
          echo "âš ï¸  Documentation has changes"
          echo "DOCS_CHANGED=true" >> $GITHUB_ENV
        fi
    
    - name: Show documentation changes
      if: env.DOCS_CHANGED == 'true'
      run: |
        echo "Documentation files that changed:"
        git diff --name-only docs/
        echo ""
        echo "Summary of changes:"
        git diff --stat docs/
    
    - name: Validate architectural boundaries
      run: |
        echo "Validating architectural boundaries..."
        
        # Check for live code in paper engine
        if grep -r "live" engine/paper_engine.py 2>/dev/null | grep -v "# " | grep -v "deliver"; then
          echo "âš ï¸  WARNING: Potential live code leak in paper_engine.py"
        fi
        
        # Check for paper code in live engine
        if grep -r "paper" engine/live_engine.py 2>/dev/null | grep -v "# " | grep -v "Parallel"; then
          echo "âš ï¸  WARNING: Potential paper code leak in live_engine.py"
        fi
        
        echo "âœ“ Boundary validation complete"
    
    - name: Commit documentation changes (on push to main)
      if: env.DOCS_CHANGED == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/
        git commit -m "docs: Auto-update documentation [skip ci]"
        git push
    
    - name: Commit documentation changes (on pull request)
      if: env.DOCS_CHANGED == 'true' && github.event_name == 'pull_request'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/
        git commit -m "docs: Auto-update documentation"
        git push origin HEAD:${{ github.head_ref }}
    
    - name: Comment on PR with warnings
      if: env.DOCS_CHANGED == 'true' && github.event_name == 'pull_request' && steps.check_changes.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = `## ðŸ“š Documentation Auto-Update
          
          The documentation has been automatically updated to reflect your code changes.
          
          ### Files Updated:
          - docs/ folder has been regenerated
          
          ### âš ï¸ Important Reminders:
          - Verify that architectural boundaries are respected (paper vs live)
          - Check that new strategies are properly documented
          - Ensure API endpoint changes are reflected in Dashboard.md
          
          ### ðŸ“ Review Checklist:
          - [ ] Documentation accurately reflects code changes
          - [ ] No live code leaked into paper engine
          - [ ] No paper code leaked into live engine
          - [ ] Strategy list is up to date
          - [ ] Indicator list is complete
          
          *This is an automated message. Documentation is regenerated on every PR.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
    
    - name: Summary
      run: |
        echo "### Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Generated: 15 documentation files" >> $GITHUB_STEP_SUMMARY
        echo "- Location: \`docs/\` directory" >> $GITHUB_STEP_SUMMARY
        echo "- Status: $(if [ "$DOCS_CHANGED" = "true" ]; then echo "âœ“ Updated"; else echo "âœ“ Up to date"; fi)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files:" >> $GITHUB_STEP_SUMMARY
        ls -1 docs/*.md | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
