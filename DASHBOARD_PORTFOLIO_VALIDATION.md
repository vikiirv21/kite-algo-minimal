# Dashboard Portfolio API Validation

## Summary
The `/api/portfolio` endpoint has been successfully refactored to use the same telemetry files as `analyze_performance.py`.

## Data Sources

### Primary Source: runtime_metrics.json
Generated by Performance Engine V2 via `scripts/run_analytics.py`, this file contains:
- Overall equity metrics (starting capital, current equity, realized/unrealized PnL)
- Per-strategy performance metrics
- Per-symbol performance metrics

### Secondary Source: paper_state_latest.json
Generated by the trading engine, this file contains:
- Current positions with symbol, quantity, avg_price, ltp
- Real-time equity snapshot
- Mode and timestamp

## Implementation Details

### Helper Functions
1. **`load_runtime_metrics()`**
   - Loads `artifacts/analytics/runtime_metrics.json`
   - Returns dict with equity, overall, per_strategy, per_symbol metrics
   - Returns None if file doesn't exist or can't be loaded

2. **`load_paper_state_checkpoint()`**
   - Loads from multiple fallback paths:
     - `artifacts/checkpoints/paper_state_latest.json` (preferred)
     - `artifacts/checkpoints/paper_state.json`
     - `artifacts/checkpoints/runtime_state_latest.json`
     - `artifacts/paper_state_latest.json`
     - `artifacts/paper_state.json`
   - Returns dict with positions, equity, pnl data
   - Returns None if no checkpoint found

### Endpoint Logic: /api/portfolio

1. **Load data from both sources**
   ```python
   metrics = load_runtime_metrics() or {}
   state = load_paper_state_checkpoint() or {}
   ```

2. **Extract overall metrics with fallback chain**
   - Starting Capital: runtime_metrics → checkpoint → config
   - Current Equity: runtime_metrics → checkpoint calculation
   - Realized PnL: runtime_metrics → checkpoint
   - Unrealized PnL: runtime_metrics → computed from positions

3. **Process positions**
   - Load positions from checkpoint
   - Resolve LTP: checkpoint → quotes cache → ticks cache → avg_price fallback
   - Compute per-position PnL:
     - LONG: `(ltp - avg_price) * qty`
     - SHORT: `(avg_price - ltp) * abs(qty)`
   - Compute PnL%: `(pnl / notional) * 100`

4. **Return JSON structure**
   ```json
   {
     "equity": 502500.50,
     "starting_capital": 500000.00,
     "daily_pnl": 2500.50,
     "realized_pnl": 2500.50,
     "unrealized_pnl": 0.00,
     "total_notional": 0.00,
     "free_margin": 502500.50,
     "open_positions": 2,
     "positions": [
       {
         "symbol": "NIFTY24DECFUT",
         "side": "LONG",
         "quantity": 50,
         "avg_price": 23500.00,
         "ltp": 23550.00,
         "pnl": 2500.00,
         "pnl_pct": 0.21,
         "notional": 1177500.00
       }
     ]
   }
   ```

## Test Results

### Manual Test: tests/manual_test_portfolio_api.py
```
✓ All required fields present
✓ All 2 positions have required fields
✓ Realized PnL matches: 2500.50
✓ Starting capital matches: 500000.00
✓ Testing Complete - All checks passed!
```

### Position PnL Calculation Validation
Test data:
- NIFTY24DECFUT: 50 qty @ 23500, LTP 23550
  - Expected PnL: (23550 - 23500) * 50 = 2500.00 ✓
  - Expected PnL%: (2500 / (50 * 23500)) * 100 = 0.21% ✓

- BANKNIFTY24DECFUT: -30 qty @ 49800, LTP 49750
  - Expected PnL: (49800 - 49750) * 30 = 1500.00 ✓
  - Expected PnL%: (1500 / (30 * 49800)) * 100 = 0.10% ✓

## Backward Compatibility

The refactored endpoint maintains the same JSON structure as before:
- Field names unchanged: `equity`, `starting_capital`, `daily_pnl`, etc.
- Position structure unchanged: `symbol`, `side`, `quantity`, `avg_price`, `ltp`, `pnl`, `pnl_pct`
- Error handling: Returns proper error structure with status 500 on exceptions

## Benefits

1. **Consistent Data**: Dashboard now shows same numbers as `analyze_performance.py`
2. **Minimal Disruption**: No changes to frontend, same API contract
3. **Robust Fallbacks**: Multiple data sources with graceful degradation
4. **Accurate PnL**: Per-position PnL computed correctly for LONG/SHORT
5. **Live Prices**: Uses LTP from checkpoint or live feed when available

## Next Steps

To see dashboard with live data:
1. Run a paper trading session:
   ```bash
   python -m scripts.run_session --mode paper --config configs/dev.yaml
   ```

2. Generate analytics:
   ```bash
   python -m scripts.run_analytics --mode paper
   ```

3. Start dashboard:
   ```bash
   uvicorn ui.dashboard:app --reload --port 8765
   ```

4. View portfolio:
   - API: http://127.0.0.1:8765/api/portfolio
   - UI: http://127.0.0.1:8765/

The portfolio summary will now show the same PnL as `scripts/analyze_performance.py`.
